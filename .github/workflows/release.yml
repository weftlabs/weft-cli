name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Verify version matches pyproject.toml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')

          if [ "${VERSION}" != "${PYPROJECT_VERSION}" ]; then
            echo "Error: Tag version (${VERSION}) doesn't match pyproject.toml version (${PYPROJECT_VERSION})"
            exit 1
          fi

          echo "âœ“ Version ${VERSION} verified"

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract changelog section for this version
          CHANGELOG=$(awk "/## \[${VERSION}\]/,/## \[/" CHANGELOG.md | sed '1d;$d')

          if [ -z "$CHANGELOG" ]; then
            echo "Warning: No changelog entry found for version ${VERSION}"
            CHANGELOG="Release ${VERSION}"
          fi

          # Save to file for release notes
          echo "${CHANGELOG}" > RELEASE_NOTES.md

          echo "Changelog extracted for v${VERSION}"

      - name: Build distribution packages
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Generate checksums
        run: |
          sha256sum dist/* > dist/SHA256SUMS
          cat dist/SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            dist/*.tar.gz
            dist/*.whl
            dist/SHA256SUMS
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## Release v${VERSION} Created! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Homebrew (will be available in a few minutes)" >> $GITHUB_STEP_SUMMARY
          echo "brew upgrade weft" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Install script" >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://raw.githubusercontent.com/weftlabs/weft-cli/main/install.sh | sh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# pipx" >> $GITHUB_STEP_SUMMARY
          echo "pipx install git+https://github.com/weftlabs/weft-cli.git@v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
