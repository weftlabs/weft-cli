x-watcher-common: &watcher-common
  image: weft-watcher:latest
  build:
    context: ${WEFT_PACKAGE_DIR:-.}
    dockerfile: Dockerfile.watcher
  volumes:
    - ${AI_HISTORY_PATH:-/tmp}:${AI_HISTORY_PATH:-/tmp}:rw
    - ${CODE_REPO_PATH:-/tmp}:${CODE_REPO_PATH:-/tmp}:ro
    # Mount worktrees separately as read-write for code generation
    - ${CODE_REPO_PATH:-/tmp}/worktrees:${CODE_REPO_PATH:-/tmp}/worktrees:rw
  restart: unless-stopped
  networks:
    - weft-network
  env_file:
    - .env.weft.common
  environment:
    - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    - WEFT_ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    - WEFT_CODE_REPO_PATH=${CODE_REPO_PATH:-/tmp}
    - WEFT_AI_HISTORY_PATH=${AI_HISTORY_PATH:-/tmp}

services:
  # Meta Agent (00) - Feature specification
  watcher-meta:
    <<: *watcher-common
    container_name: weft-watcher-meta
    env_file:
      - .env.weft.common
      - agents/00-meta/.env

  # Architect Agent (01) - Domain modeling
  watcher-architect:
    <<: *watcher-common
    container_name: weft-watcher-architect
    env_file:
      - .env.weft.common
      - agents/01-architect/.env

  # OpenAPI Agent (02) - API specification
  watcher-openapi:
    <<: *watcher-common
    container_name: weft-watcher-openapi
    env_file:
      - .env.weft.common
      - agents/02-openapi/.env

  # UI Agent (03) - Frontend scaffolding
  watcher-ui:
    <<: *watcher-common
    container_name: weft-watcher-ui
    env_file:
      - .env.weft.common
      - agents/03-ui/.env

  # Integration Agent (04) - API wiring
  watcher-integration:
    <<: *watcher-common
    container_name: weft-watcher-integration
    env_file:
      - .env.weft.common
      - agents/04-integration/.env

  # Test Agent (05) - Testing and review
  watcher-test:
    <<: *watcher-common
    container_name: weft-watcher-test
    env_file:
      - .env.weft.common
      - agents/05-test/.env

networks:
  weft-network:
    driver: bridge
